datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// USER Table

model User {
  id           Int      @id @default(autoincrement())
  username     String   @unique
  email        String   @unique
  passwordHash String
  profilePic   String?
  bio          String?
  isPrivate    Boolean  @default(false)
  createdAt    DateTime @default(now())

  // Relations Table
  posts        Post[]
  stories      Story[]
  reels        Reel[]
  likes        Like[]
  comments     PostComment[]
  saves        Save[]
  sentMessages Message[]

  followers Follower[] @relation("followers")
  following Follower[] @relation("following")

  conversationMembers ConversationMember[]
  ReelLike            ReelLike[]
  ReelComment         ReelComment[]
}

// FOLLOWERS Table

model Follower {
  id          Int      @id @default(autoincrement())
  followerId  Int
  followingId Int
  createdAt   DateTime @default(now())

  follower  User @relation("followers", fields: [followerId], references: [id])
  following User @relation("following", fields: [followingId], references: [id])

  @@unique([followerId, followingId])
}

// POSTS Table

model Post {
  id        Int       @id @default(autoincrement())
  userId    Int
  caption   String?
  mediaUrl  String
  mediaType MediaType
  location  String?
  createdAt DateTime  @default(now())

  user     User          @relation(fields: [userId], references: [id])
  likes    ReelLike[]
  comments PostComment[]
  saves    Save[]
}

// STORIES Table

model Story {
  id        Int       @id @default(autoincrement())
  userId    Int
  mediaUrl  String
  mediaType MediaType
  expiresAt DateTime
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id])
}

// REELS Table

model Reel {
  id        Int      @id @default(autoincrement())
  userId    Int
  videoUrl  String
  caption   String?
  music     String?
  createdAt DateTime @default(now())

  user     User          @relation(fields: [userId], references: [id])
  likes    ReelLike[]
  comments ReelComment[]
}

// LIKES (Post / Reel) Tables

model Like {
  id          Int         @id @default(autoincrement())
  userId      Int
  contentId   Int
  contentType ContentType
  createdAt   DateTime    @default(now())

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, contentId, contentType])
  @@index([contentId, contentType])
}

model ReelLike {
  id     Int @id @default(autoincrement())
  reelId Int
  userId Int

  reel   Reel  @relation(fields: [reelId], references: [id])
  user   User  @relation(fields: [userId], references: [id])
  Post   Post? @relation(fields: [postId], references: [id])
  postId Int?

  @@unique([reelId, userId])
}

// COMMENTS Tables (Post & Comments)

model PostComment {
  id        Int      @id @default(autoincrement())
  postId    Int
  userId    Int
  text      String
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id])
  user User @relation(fields: [userId], references: [id])
}

model ReelComment {
  id        Int      @id @default(autoincrement())
  reelId    Int
  userId    Int
  text      String
  createdAt DateTime @default(now())

  reel Reel @relation(fields: [reelId], references: [id])
  user User @relation(fields: [userId], references: [id])
}

// SAVES (Bookmarks) Tables

model Save {
  id        Int      @id @default(autoincrement())
  userId    Int
  postId    Int
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  post Post @relation(fields: [postId], references: [id])

  @@unique([userId, postId])
}

// CONVERSATIONS Table

model Conversation {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  members  ConversationMember[]
  messages Message[]
}

model ConversationMember {
  id             Int @id @default(autoincrement())
  conversationId Int
  userId         Int

  conversation Conversation @relation(fields: [conversationId], references: [id])
  user         User         @relation(fields: [userId], references: [id])

  @@unique([conversationId, userId])
}

// MESSAGES Table

model Message {
  id             Int      @id @default(autoincrement())
  conversationId Int
  senderId       Int
  messageText    String?
  mediaUrl       String?
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id])
  sender       User         @relation(fields: [senderId], references: [id])
}

// ENUMS

enum MediaType {
  IMAGE
  VIDEO
}

enum ContentType {
  POST
  REEL
}

